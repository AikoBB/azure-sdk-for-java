# intended to be used as part of a release process
parameters:
  WorkingDirectory: ''
  ScriptDirectory: eng/common/scripts
  TargetDocRepoName: ''
  TargetDocRepoOwner: ''


steps:
- pwsh: |
    git clone https://github.com/${{ parameters.TargetDocRepoOwner }}/${{ parameters.TargetDocRepoName }} ${{ parameters.WorkingDirectory }}/repo
  displayName: Clone Documentation Repository
- template: /eng/common/pipelines/templates/steps/set-default-branch.yml
  parameters:
    WorkingDirectory: ${{ parameters.WorkingDirectory }}/repo 

- pwsh: |
    $ciLastCommit = git log --author="VSC-Service-Account" --pretty=format:'%H' -n 1
    Write-Host $ciLastCommit
    echo "##vso[task.setvariable variable=CICommit]$ciLastCommit"
  displayName: Fetch the last commit for Job CI commits.
  workingDirectory: ${{ parameters.workingDirectory }}/repo
- pwsh: |
    git reset --hard $(CICommit)
    git checkout -b for-release
  displayName: Checkout new branch 'for-release'
  workingDirectory: ${{ parameters.workingDirectory }}/repo
- template: /eng/common/pipelines/templates/steps/git-push-changes.yml
  parameters:
    BaseRepoBranch: 'live'
    BaseRepoOwner: ${{ parameters.TargetDocRepoOwner }}
    CommitMsg: "Daily merge updated API to live."
    TargetRepoName: ${{ parameters.TargetDocRepoName }}
    TargetRepoOwner: ${{ parameters.TargetDocRepoOwner }}
    WorkingDirectory: ${{ parameters.WorkingDirectory }}/repo
    ScriptDirectory: ${{ parameters.WorkingDirectory }}/${{ parameters.ScriptDirectory }}
    SkipCheckingForChanges: true
    PushArgs: -f 

